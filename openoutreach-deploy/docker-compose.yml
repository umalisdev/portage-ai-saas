# ─────────────────────────────────────────────────────────────────────
# docker-compose.yml — OpenOutreach + Dashboard Portage AI
# Déploiement de production clé en main
# ─────────────────────────────────────────────────────────────────────
#
# Usage rapide:
#   1. cp .env.example .env && nano .env
#   2. docker compose up -d --build
#   3. docker compose logs -f app
#
# Services:
#   - app:      Daemon de scraping LinkedIn (Playwright + xvfb)
#   - crm:      Interface web CRM Django (port 8000)
#   - exporter: Export automatique des profils vers le dashboard (toutes les heures)

services:

  # ─── Daemon de scraping LinkedIn ────────────────────────────────────
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: openoutreach-daemon
    restart: unless-stopped
    command: daemon
    env_file:
      - .env
    volumes:
      - openoutreach_data:/app/assets
      - dashboard_html:/dashboard
    depends_on:
      init:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'

  # ─── Initialisation (migrations + config Portage AI) ────────────────
  init:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: openoutreach-init
    command: init
    env_file:
      - .env
    volumes:
      - openoutreach_data:/app/assets

  # ─── Interface web CRM Django ───────────────────────────────────────
  crm:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: openoutreach-crm
    restart: unless-stopped
    command: crm
    env_file:
      - .env
    volumes:
      - openoutreach_data:/app/assets
    ports:
      - "${CRM_PORT:-8000}:8000"
    depends_on:
      init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/admin/')"]
      interval: 60s
      timeout: 10s
      retries: 3

  # ─── Export automatique vers le dashboard (cron) ────────────────────
  exporter:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: openoutreach-exporter
    restart: unless-stopped
    command: exporter
    env_file:
      - .env
    environment:
      - EXPORT_INTERVAL=${EXPORT_INTERVAL:-3600}
      - DASHBOARD_PATH=/dashboard/dashboard.html
    volumes:
      - openoutreach_data:/app/assets
      - dashboard_html:/dashboard
    depends_on:
      init:
        condition: service_completed_successfully

volumes:
  openoutreach_data:
    driver: local
  dashboard_html:
    driver: local
